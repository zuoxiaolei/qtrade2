select code,
       name,
       date,
       close,
       get_cdf(close, close_roll_mean, close_roll_std)   cdf,
       (close_0 - close_min) / (close_max - close_min)   close_0,
       (close_1 - close_min) / (close_max - close_min)   close_1,
       (close_2 - close_min) / (close_max - close_min)   close_2,
       (close_3 - close_min) / (close_max - close_min)   close_3,
       (close_4 - close_min) / (close_max - close_min)   close_4,
       (close_5 - close_min) / (close_max - close_min)   close_5,
       (close_6 - close_min) / (close_max - close_min)   close_6,
       (close_7 - close_min) / (close_max - close_min)   close_7,
       (close_8 - close_min) / (close_max - close_min)   close_8,
       (close_9 - close_min) / (close_max - close_min)   close_9,
       (close_10 - close_min) / (close_max - close_min)  close_10,
       (close_11 - close_min) / (close_max - close_min)  close_11,
       (close_12 - close_min) / (close_max - close_min)  close_12,
       (close_13 - close_min) / (close_max - close_min)  close_13,
       (close_14 - close_min) / (close_max - close_min)  close_14,
       (close_15 - close_min) / (close_max - close_min)  close_15,
       (close_16 - close_min) / (close_max - close_min)  close_16,
       (close_17 - close_min) / (close_max - close_min)  close_17,
       (close_18 - close_min) / (close_max - close_min)  close_18,
       (close_19 - close_min) / (close_max - close_min)  close_19,
       (close_20 - close_min) / (close_max - close_min)  close_20,
       (close_21 - close_min) / (close_max - close_min)  close_21,
       (close_22 - close_min) / (close_max - close_min)  close_22,
       (close_23 - close_min) / (close_max - close_min)  close_23,
       (close_24 - close_min) / (close_max - close_min)  close_24,
       (close_25 - close_min) / (close_max - close_min)  close_25,
       (close_26 - close_min) / (close_max - close_min)  close_26,
       (close_27 - close_min) / (close_max - close_min)  close_27,
       (close_28 - close_min) / (close_max - close_min)  close_28,
       (close_29 - close_min) / (close_max - close_min)  close_29,
       (close_30 - close_min) / (close_max - close_min)  close_30,
       (close_31 - close_min) / (close_max - close_min)  close_31,
       (close_32 - close_min) / (close_max - close_min)  close_32,
       (close_33 - close_min) / (close_max - close_min)  close_33,
       (close_34 - close_min) / (close_max - close_min)  close_34,
       (close_35 - close_min) / (close_max - close_min)  close_35,
       (close_36 - close_min) / (close_max - close_min)  close_36,
       (close_37 - close_min) / (close_max - close_min)  close_37,
       (close_38 - close_min) / (close_max - close_min)  close_38,
       (close_39 - close_min) / (close_max - close_min)  close_39,
       (close_40 - close_min) / (close_max - close_min)  close_40,
       (close_41 - close_min) / (close_max - close_min)  close_41,
       (close_42 - close_min) / (close_max - close_min)  close_42,
       (close_43 - close_min) / (close_max - close_min)  close_43,
       (close_44 - close_min) / (close_max - close_min)  close_44,
       (close_45 - close_min) / (close_max - close_min)  close_45,
       (close_46 - close_min) / (close_max - close_min)  close_46,
       (close_47 - close_min) / (close_max - close_min)  close_47,
       (close_48 - close_min) / (close_max - close_min)  close_48,
       (close_49 - close_min) / (close_max - close_min)  close_49,
       (close_50 - close_min) / (close_max - close_min)  close_50,
       (close_51 - close_min) / (close_max - close_min)  close_51,
       (close_52 - close_min) / (close_max - close_min)  close_52,
       (close_53 - close_min) / (close_max - close_min)  close_53,
       (close_54 - close_min) / (close_max - close_min)  close_54,
       (close_55 - close_min) / (close_max - close_min)  close_55,
       (close_56 - close_min) / (close_max - close_min)  close_56,
       (close_57 - close_min) / (close_max - close_min)  close_57,
       (close_58 - close_min) / (close_max - close_min)  close_58,
       (close_59 - close_min) / (close_max - close_min)  close_59,
       (close_60 - close_min) / (close_max - close_min)  close_60,
       (close_61 - close_min) / (close_max - close_min)  close_61,
       (close_62 - close_min) / (close_max - close_min)  close_62,
       (close_63 - close_min) / (close_max - close_min)  close_63,
       (close_64 - close_min) / (close_max - close_min)  close_64,
       (close_65 - close_min) / (close_max - close_min)  close_65,
       (close_66 - close_min) / (close_max - close_min)  close_66,
       (close_67 - close_min) / (close_max - close_min)  close_67,
       (close_68 - close_min) / (close_max - close_min)  close_68,
       (close_69 - close_min) / (close_max - close_min)  close_69,
       (close_70 - close_min) / (close_max - close_min)  close_70,
       (close_71 - close_min) / (close_max - close_min)  close_71,
       (close_72 - close_min) / (close_max - close_min)  close_72,
       (close_73 - close_min) / (close_max - close_min)  close_73,
       (close_74 - close_min) / (close_max - close_min)  close_74,
       (close_75 - close_min) / (close_max - close_min)  close_75,
       (close_76 - close_min) / (close_max - close_min)  close_76,
       (close_77 - close_min) / (close_max - close_min)  close_77,
       (close_78 - close_min) / (close_max - close_min)  close_78,
       (close_79 - close_min) / (close_max - close_min)  close_79,
       (close_80 - close_min) / (close_max - close_min)  close_80,
       (close_81 - close_min) / (close_max - close_min)  close_81,
       (close_82 - close_min) / (close_max - close_min)  close_82,
       (close_83 - close_min) / (close_max - close_min)  close_83,
       (close_84 - close_min) / (close_max - close_min)  close_84,
       (close_85 - close_min) / (close_max - close_min)  close_85,
       (close_86 - close_min) / (close_max - close_min)  close_86,
       (close_87 - close_min) / (close_max - close_min)  close_87,
       (close_88 - close_min) / (close_max - close_min)  close_88,
       (close_89 - close_min) / (close_max - close_min)  close_89,
       (close_90 - close_min) / (close_max - close_min)  close_90,
       (close_91 - close_min) / (close_max - close_min)  close_91,
       (close_92 - close_min) / (close_max - close_min)  close_92,
       (close_93 - close_min) / (close_max - close_min)  close_93,
       (close_94 - close_min) / (close_max - close_min)  close_94,
       (close_95 - close_min) / (close_max - close_min)  close_95,
       (close_96 - close_min) / (close_max - close_min)  close_96,
       (close_97 - close_min) / (close_max - close_min)  close_97,
       (close_98 - close_min) / (close_max - close_min)  close_98,
       (close_99 - close_min) / (close_max - close_min)  close_99,
       (close_100 - close_min) / (close_max - close_min) close_100,
       (close_101 - close_min) / (close_max - close_min) close_101,
       (close_102 - close_min) / (close_max - close_min) close_102,
       (close_103 - close_min) / (close_max - close_min) close_103,
       (close_104 - close_min) / (close_max - close_min) close_104,
       (close_105 - close_min) / (close_max - close_min) close_105,
       (close_106 - close_min) / (close_max - close_min) close_106,
       (close_107 - close_min) / (close_max - close_min) close_107,
       (close_108 - close_min) / (close_max - close_min) close_108,
       (close_109 - close_min) / (close_max - close_min) close_109,
       get_predict_udf(close, close_roll_ahead)          y
from (select date,
             close,
             avg(close)
                 over (partition by code order by date rows between {} preceding and current row)    close_roll_mean,
             stddev(close)
                    over (partition by code order by date rows between {} preceding and current row) close_roll_std, {}
          collect_list(close) over (partition by code order by date rows between current row and {} following) close_roll_ahead, code, name, max(close) over (partition by code order by date ROWS BETWEEN UNBOUNDED PRECEDING and UNBOUNDED following) close_max, min(close) over (partition by code order by date ROWS BETWEEN UNBOUNDED PRECEDING and UNBOUNDED following) close_min
      from df_origin_rdd) t
where {}
order by code, date
;

select `date`,
       sum(if(`close` / close_1 > 1, 1, 0)) increase_count,
       sum(if(`close` / close_1 < 1, 1, 0)) down_count,
       count(1) all_count
from (
             select date,
                    `close`,
                    `code`,
                    lag(close, 1) over (partition by code order by date) close_1
from df t) t
where close_1 is not null
group by date
order by date
;